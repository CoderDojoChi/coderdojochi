machine:
  python:
    version: 2.7.11
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
  pre:
    - pip install awsebcli
  override:
    - docker info
    - if [[ -e ~/docker/$DOCKER_USER_$DOCKER_REPO ]]; then docker load --input ~/docker/$DOCKER_USER_$DOCKER_REPO; fi
    - docker build -t "$DOCKER_USER/$DOCKER_REPO" .
    - mkdir -p ~/docker; docker save $DOCKER_USER/$DOCKER_REPO > ~/docker/$DOCKER_USER_$DOCKER_REPO
    - if [[ -e ~/docker/$DOCKER_USER_$DOCKER_REPO-static ]]; then docker load --input ~/docker/$DOCKER_USER_$DOCKER_REPO-static; fi
    - docker build -t "$DOCKER_USER/$DOCKER_REPO-static" ./coderdojochi/static
    - mkdir -p ~/docker; docker save $DOCKER_USER/$DOCKER_REPO-static > ~/docker/$DOCKER_USER_$DOCKER_REPO-static

test:
  override:
    - echo True

deployment:
  elasticbeanstalk:
    branch: feature/docker-circleci
    commands:
      - docker login  -e "$DOCKER_EMAIL" -u "$DOCKER_USER" -p "$DOCKER_PASS"
      - docker push "$DOCKER_USER/$DOCKER_REPO:$CIRCLE_BUILD_NUM"
      - docker push "$DOCKER_USER/$DOCKER_REPO-static:$CIRCLE_BUILD_NUM"
      - sed -i'' -e "s;%USER%;$DOCKER_USER;g" ./deploy/Dockerrun.aws.json
      - sed -i'' -e "s;%REPO%;$DOCKER_REPO;g" ./deploy/Dockerrun.aws.json
      - sed -i'' -e "s;%BUILD_NUM%;$CIRCLE_BUILD_NUM;g" ./deploy/Dockerrun.aws.json
      - cd ./deploy && eb init -p "64bit Amazon Linux 2015.09 v2.0.8 running Multi-container Docker 1.9.1 (Generic)" -r us-east-1 $DOCKER_REPO
      - cd ./deploy && eb deploy -l $CIRCLE_BUILD_NUM $DOCKER_REPO
